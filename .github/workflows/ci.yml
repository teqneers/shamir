name: CI
on:
  push:
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'example'
    branches: [ master ]
  pull_request:
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'example'
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        php-version: [
            "8.1",
            "8.2",
            "8.3"
        ]
        composer-param: [
            "update --no-progress --prefer-source --prefer-lowest",
            "update --no-progress --prefer-source"
        ]
    name: PHP ${{ matrix.php-version }} test
    steps:
      - name: checkout project
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: bcmath
          tools: composer:v2
          # For PHPUnit code coverage, we need xdebug
#          coverage: xdebug

      - name: Validate composer.json and composer.lock
        run: composer validate

#      - name: Cache Composer packages
#        id: composer-cache
#        uses: actions/cache@v3
#        with:
#          path: vendor
#          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
#          restore-keys: |
#            ${{ runner.os }}-php-

      - name: Install dependencies
#        if: steps.composer-cache.outputs.cache-hit != 'true'
        run: composer ${{ matrix.composer-param }}

      # Run phpunit with code coverage
      - name: PHPUnit Tests
#        run: vendor/bin/phpunit --coverage-clover=coverage.clover
        run: vendor/bin/phpunit

      # For code coverage report we are uploading our code coverage report to scrutinizer
      - name: Downloading scrutinizer ocular.phar
        run: wget https://scrutinizer-ci.com/ocular.phar

      # Uploading reports for analysis
      - name: Upload code-coverage to scrutinizer
        run: php ocular.phar code-coverage:upload --format=php-clover coverage.clover

# vim: syntax=yaml ts=2 sw=2 et sr softtabstop=2 autoindent
